<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Blurt Now</title>
    <link href="css/styles.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css" rel="stylesheet" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" crossorigin="anonymous"></script>
  </head>
  <body class="container">
    <nav class="bg-dark">
    </nav>
    <div class="row justify-content-center">
        <div class="col-md-12 col-sm-12">
            <main>
                <div class="container-fluid">
                    <div>
                      &nbsp;
                    </div>
                    <div class="row">
                      <div class="col-lg-4 col-md-12 col-sm-12">
                          <div class="card mb-4">
                              <div class="card-header">
                                  <i class="fas fa-chart-area mr-1"></i>
                                  @<small id="usernameDisp"></small>
                              </div>
                              <div class="card-body">
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="card mb-4">
                          <div class="card-header">
                              <i class="fas fa-dollar-sign mr-1"></i>
                            <small>Daily Rewards</small>
                          </div>
                          <div class="card-body">
                            <table class="table table-borderless">
                              <tbody>
                                <tr>
                                  <th scope="row"><small>Curation Today</small></th>
                                  <td><small>Mark</small></td>
                                </tr>
                                <tr>
                                  <th scope="row"><small>Author Today</small></th>
                                  <td><small>Jacob</small></td>
                                </tr>
                                <tr>
                                  <th scope="row"><small>Curation Yesterday</small></th>
                                  <td><small>Larry</small></td>
                                </tr>
                                <tr>
                                  <th scope="row"><small>Author Yesterday</small></th>
                                  <td><small>Larry</small></td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="card mb-4">
                          <div class="card-header">
                              <i class="fas fa-user-cog mr-1"></i>
                              <small>Settings</small>
                          </div>
                          <div class="card-body">
                            <form>
                              <div class="form-group row">
                                <label for="staticEmail" class="col-sm-4 col-form-label col-form-label-sm">Username</label>
                                <div class="col-sm-8">
                                  <input type="text" class="form-control form-control-sm" id="username" value="eastmael">
                                </div>
                              </div>
                              <div class="form-group row">
                                <label for="inputPassword" class="col-sm-4 col-form-label col-form-label-sm"></label>
                                <div class="col-sm-8">
                                  <button type="submit" class="btn btn-primary mb-2 btn-sm" id="save">Save</button>
                                </div>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header">
                          <i class="fas fa-table mr-1"></i>
                          <small>Latest Upvotes</small>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-borderless" id="latestUpvotes" width="100%" cellspacing="0">
                              </table>
                          </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header">
                          <i class="fas fa-table mr-1"></i>
                          <small>Latest Curation Rewards</small>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-borderless" id="latestCurationRewards" width="100%" cellspacing="0">
                              </table>
                          </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header">
                          <i class="fas fa-table mr-1"></i>
                          <small>Latest Author Rewards</small>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-borderless" id="latestAuthorRewards" width="100%" cellspacing="0">
                              </table>
                          </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-table mr-1"></i>
                            <small>Latest Posts</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-borderless" id="latestPosts" width="100%" cellspacing="0">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer class="py-4 bg-light mt-auto">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-between small">
                        <div class="text-muted">&copy; blurtnow.com by <a href="https://blurt.world/@eastmael">@eastmael</a> for <a href="https://blurt.world">blurt</a></div>
                        <div>
                            <a href="#">Privacy Policy</a>
                            &middot;
                            <a href="#">Terms &amp; Conditions</a>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@blurtfoundation/blurtjs/dist/blurt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js" integrity="sha512-rmZcZsyhe0/MAjquhTgiUcb4d9knaFc7b5xAfju483gbEXTkeJRUMIPk6s3ySZMYUHEcjKbjLjyddGWMrNEvZg==" crossorigin="anonymous"></script>
    <script>
      const BLURT_WORLD = "https://blurt.world/";
      const BLURT_EXPLORER = "https://blocks.blurtwallet.com/#";
      blurt.api.setOptions({ url: 'https://rpc.blurt.world', useAppbaseApi: true });

      function getPosts() {
        const username = $("#username").val();
        let today = moment().utc().format().split("Z")[0];

        blurt.api.getDiscussionsByAuthorBeforeDate(username, "", today, 100, function(err, response){
          console.log('response', response);
          var table = $('#latestPosts');
          let totalRewards = 0;
          let latestPost = moment();
          let toPayoutDate = moment();
          response.forEach(item => {
            let {
              pending_payout_value, total_author_payout, total_curator_payout,
              created, title, url,
            } = item;

            let payout = pending_payout_value;
            let timeAgo = moment(created).fromNow();
            if (item.abs_rshares > 0) {
              latestPost = moment(created);
              totalRewards = totalRewards + parseFloat(payout.split("BLURT")[0]);
              var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `${payout} | <a href="${BLURT_WORLD}/${url}">${title}</a>` + '</small></td></tr>');
              table.append(row);
            }
          });

          if (totalRewards > 0) {
            var row = $('<tr><td><small>' + `${latestPost.to(toPayoutDate)}` + '</small></td><td><small>' + `${totalRewards.toFixed(2)} BLURT | Total Pending Rewards` + '</small></td></tr>');
            table.append(row);
          } else {
            var row = $('<tr><td><small>No results...</small></td></tr>');
            table.append(row);
          }
        });
      }

      function getAccountHistory() {
        const username = $("#username").val();
        let today = moment().utc().format().split("Z")[0];

        blurt.api.getAccountHistory(username, -1, 1000, function(err, response){
          let authorRewards = response.slice(0).filter(item => item[1].op[0] === "author_reward")
          let authorRewardsTable = $('#latestAuthorRewards');
          authorRewards.forEach(item => {
            let { block, op, timestamp } = item[1];
            let { author, vesting_payout, permlink } = op[1];
            let timeAgo = moment(timestamp).fromNow();
            let title = `@${author}/${permlink}`;
            var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `${vesting_payout} | <a href="${BLURT_EXPLORER}/${title}" target="_blank">${title}</a>` + '</small></td></tr>');
            authorRewardsTable.append(row);
          });

          let curationRewards = response.slice(0).filter(item => item[1].op[0] === "curation_reward")
          console.log('curationRewards', curationRewards);
          let curationRewardsTable = $('#latestCurationRewards');
          curationRewards.forEach(item => {
            let { block, op, timestamp } = item[1];
            let { comment_author, reward, comment_permlink } = op[1];
            let timeAgo = moment(timestamp).fromNow();
            let title = `@${comment_author}/${comment_permlink}`;
            var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `${reward} | <a href="${BLURT_EXPLORER}/${title}" target="_blank">${title}</a>` + '</small></td></tr>');
            curationRewardsTable.append(row);
          });
        });
      }

      let username = "";
      let storedUsername = window.localStorage.getItem("username");
      if (storedUsername) {
        $("#username").val(storedUsername);
        username = storedUsername;
      } else {
        username = $("#username").val();
      }
      $("#usernameDisp").text(username);

      getPosts();
      getAccountHistory();
      $("#save").on('click', function() {
        $("#latestPosts tr").remove();
        $("#latestAuthorRewards tr").remove();

        let username = $("#username").val();
        window.localStorage.setItem("username", username);
        $("#usernameDisp").text(username);
        getPosts();
      });
      
    </script>
</body>
</head>
</html>