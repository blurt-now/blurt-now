<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Blurt Now</title>
    <link rel="icon" href="./assets/img/blurtopian_07_N9S_icon.ico" type="image/icon type">
    <link href="css/styles.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css" rel="stylesheet" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" crossorigin="anonymous"></script>
  </head>
  <body class="container">
    <nav class="bg-dark">
    </nav>
    <div class="row justify-content-center">
        <div class="col-md-12 col-sm-12">
            <main>
                <div class="container-fluid">
                    <div>
                      &nbsp;
                    </div>
                    <div class="row">
                      <div class="col-lg-4 col-md-12 col-sm-12">
                          <div class="card mb-4">
                              <div class="card-header pt-0 pb-0">
                                  <i class="fas fa-chart-area mr-1"></i>
                                  @<small id="usernameDisp"></small>
                              </div>
                              <div class="card-body">
                                <table style="display: flex;">
                                  <tr>
                                    <td>
                                      <div>
                                        <input type="text" readonly class="form-control-sm form-control-plaintext" id="balance" value="0.0 BLURT" />
                                      </div>
                                      <div>
                                        <input type="text" readonly class="form-control-sm form-control-plaintext" id="vestingShares" value="0.0 BP" />
                                      </div>
                                    </td>
                                    <td>
                                      <div style="justify-content: center;">
                                        Your <span id="voteWeight">100</span>% upvote is worth:
                                      </div>
                                      <div>
                                        <input id="voteSlider" type="range" style="width:120px" min="1" max="100" step="1" value="100" />
                                      </div>
                                      <div>
                                        $<span id="voteValue">0.00</span>
                                      </div>
                                    </td>
                                  </tr>
                                </table>
                              </div>
                          </div>
                      </div>
                      <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="card mb-4">
                          <div class="card-header pt-0 pb-0">
                              <i class="fas fa-dollar-sign mr-1"></i>
                            <small>Daily Rewards</small>
                          </div>
                          <div class="card-body pt-0 pb-0">
                            <div>
                              <div class="form-group row mb-0">
                                <label for="staticEmail" class="col-sm-6 col-form-label col-form-label-sm">Curation Today</label>
                                <div class="col-sm-6">
                                  <input type="text" readonly class="form-control-sm form-control-plaintext" id="curationRewardsToday" value="0.0 BP" />
                                </div>
                              </div>
                              <div class="form-group row mb-0">
                                <label for="inputPassword" class="col-sm-6 col-form-label col-form-label-sm">Author Today</label>
                                <div class="col-sm-6">
                                  <input type="text" readonly class="form-control-sm form-control-plaintext" id="authorRewardsToday" value="0.0 BP" />
                                </div>
                              </div>
                              <div class="form-group row mb-0">
                                <label for="inputPassword" class="col-sm-6 col-form-label col-form-label-sm">Curation Yesterday</label>
                                <div class="col-sm-6">
                                  <input type="text" readonly class="form-control-sm form-control-plaintext" id="curationRewardsYesterday" value="0.0 BP" />
                                </div>
                              </div>
                              <div class="form-group row mb-0">
                                <label for="inputPassword" class="col-sm-6 col-form-label col-form-label-sm">Author Yesterday</label>
                                <div class="col-sm-6">
                                  <input type="text" readonly class="form-control-sm form-control-plaintext" id="authorRewardsYesterday" value="0.0 BP" />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="card mb-4">
                          <div class="card-header pt-0 pb-0">
                              <i class="fas fa-user-cog mr-1"></i>
                              <small>Settings</small>
                          </div>
                          <div class="card-body">
                            <form>
                              <div class="form-group row">
                                <label for="staticEmail" class="col-lg-4 col-md-3 col-sm-3 col-form-label col-form-label-sm">Username</label>
                                <div class="col-lg-8 col-md-9 col-sm-9">
                                  <input type="text" class="form-control form-control-sm" id="username" value="eastmael">
                                </div>
                              </div>
                              <div class="form-group row">
                                <label for="inputPassword" class="col-lg-4 col-md-3 col-sm-3 col-form-label col-form-label-sm"></label>
                                <div class="col-lg-8 col-md-9 col-sm-9">
                                  <button type="submit" class="btn btn-primary mb-2 btn-sm" id="save">Save</button>
                                </div>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row mt-0 mb-2">
                      <div class="col-12">
                        <div class="progress">
                          <div id="votingBar" class="progress-bar" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"><span id="votingPower">voting power: 75</span></div>
                        </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header pt-0 pb-0">
                          <i class="fas fa-table mr-1"></i>
                          <small>Latest Upvotes</small>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive-lg" style="max-height: 150px;overflow-y: auto;">
                              <table class="table table-sm table-borderless" id="latestUpvotes" width="100%" cellspacing="0">
                              </table>
                          </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header pt-0 pb-0">
                          <i class="fas fa-table mr-1"></i>
                          <small>Latest Curation Rewards</small>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive-lg" style="max-height: 150px;overflow-y: auto;">
                              <table class="table table-sm table-borderless" id="latestCurationRewards" width="100%" cellspacing="0">
                              </table>
                          </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header pt-0 pb-0">
                          <i class="fas fa-table mr-1"></i>
                          <small>Latest Author Rewards</small>
                      </div>
                      <div class="card-body">
                          <div class="table-responsive-lg" style="max-height: 150px;overflow-y: auto;">
                              <table class="table table-sm table-borderless" id="latestAuthorRewards" width="100%" cellspacing="0">
                              </table>
                          </div>
                      </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header pt-0 pb-0">
                            <i class="fas fa-table mr-1"></i>
                            <small>Latest Posts</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive-lg" style="max-height: 150px;overflow-y: auto;">
                                <table class="table table-sm table-borderless" id="latestPosts" width="100%" cellspacing="0">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer class="py-4 bg-light mt-auto">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-between small">
                        <div class="text-muted">&copy; blurtnow.com by <a href="https://blurt.world/@eastmael">@eastmael</a> for <a href="https://blurt.world">blurt</a></div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@blurtfoundation/blurtjs/dist/blurt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js" integrity="sha512-rmZcZsyhe0/MAjquhTgiUcb4d9knaFc7b5xAfju483gbEXTkeJRUMIPk6s3ySZMYUHEcjKbjLjyddGWMrNEvZg==" crossorigin="anonymous"></script>
    <script>
      const BLURT_WORLD = "https://blurt.world";
      const BLURT_EXPLORER = "https://blocks.blurtwallet.com/#";
      blurt.api.setOptions({ url: 'https://rpc.blurt.world', useAppbaseApi: true });

      function M(e) {
        var t = e * u;
        return t = t.toFixed(3).replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,")
      }
      function getAccount() {
        const username = $("#username").val();
        blurt.api.getAccounts([username], function(err, response) {
          console.log('account', response[0]);
          let account = response[0];
          let { balance, vesting_shares, voting_power, received_vesting_shares, delegated_vesting_shares, vesting_withdraw_rate } = account;
          $("#balance").val(balance);

          vesting_shares = parseFloat(vesting_shares.split(" ")[0]).toFixed(3);
          $("#vestingShares").val(vesting_shares + " BP");

          $("#voteSlider").on("input", function() {
            $("#voteWeight").text($(this).val())
          });
          $("#voteSlider").on("change", function() {
            // TO DO:
            var d = 0;
            var a = M(d = parseInt(parseInt(vesting_shares.replace(" VESTS", "")) + parseInt(received_vesting_shares.replace(" VESTS", "")) - parseInt(delegated_vesting_shares.replace(" VESTS", "")) - parseInt(vesting_withdraw_rate.replace(" VESTS", ""))));
                $("#vesting_shares").text(a + " " + "P");
            var p = parseInt(100 * voting_power * (100 * $("#vote_weight").text()) / b);
                p = parseInt((p + 49) / 50);
                var c = parseInt(d * p * 100)
                  , u = ((c + 2e12) * (c + 2e12) - 4e24) / (c + 8e12) * g * h;
                $("#vote_value").text(u.toFixed(2))
          });
          let votePct = voting_power / 100;
          $("#votingBar").attr("aria-valuenow", votePct)
          $("#votingBar").css("width", votePct + " %")
          $("#votingPower").text(`voting power: ${votePct}%`)
        });
      }

      function getPosts() {
        const username = $("#username").val();
        let today = moment().utc().format().split("Z")[0];

        blurt.api.getDiscussionsByAuthorBeforeDate(username, "", today, 100, function(err, response){
          var table = $('#latestPosts');
          let totalRewards = 0;
          let latestPost = moment();
          let toPayoutDate = moment();
          response.forEach(item => {
            let {
              pending_payout_value, total_author_payout, total_curator_payout,
              created, title, url,
            } = item;

            let payout = pending_payout_value;
            let timeAgo = moment.utc().to(moment.utc(created));
            if (item.abs_rshares > 0) {
              latestPost = moment(created);
              totalRewards = totalRewards + parseFloat(payout.split("BLURT")[0]);
              var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `${payout} | <a href="${BLURT_WORLD}${url}" target="_blank">${title}</a>` + '</small></td></tr>');
              table.append(row);
            }
          });

          if (totalRewards > 0) {
            var row = $('<tr><td><small>' + `${latestPost.to(toPayoutDate)}` + '</small></td><td><small>' + `${totalRewards.toFixed(3)} BLURT | Total Pending Rewards` + '</small></td></tr>');
            table.append(row);
          } else {
            var row = $('<tr><td><small>No results...</small></td></tr>');
            table.append(row);
          }
        });
      }

      function getAccountHistory() {
        const username = $("#username").val();
        let today = moment().utc();

        blurt.api.getAccountHistory(username, -1, 1000, function(err, response){
          let authorRewards = response.slice(0).filter(item => item[1].op[0] === "author_reward")
          authorRewards.sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
          let authorRewardsTable = $('#latestAuthorRewards');
          let authorRewardsToday = 0.0, authorRewardsYesterday = 0.0;
          authorRewards.forEach(item => {
            let { block, op, timestamp } = item[1];
            let { author, vesting_payout, permlink } = op[1];
            let timeAgo = moment(timestamp).fromNow();
            let title = `@${author}/${permlink}`;
            var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `${vesting_payout.replace("VESTS", "BP")} | <a href="${BLURT_EXPLORER}/${title}" target="_blank">${title}</a>` + '</small></td></tr>');
            authorRewardsTable.append(row);

            if (today.isSame(moment(timestamp), "day")) {
              authorRewardsToday += parseFloat(vesting_payout.split(" ")[0]);
            } else if (today.subtract(1, 'days').isSame(moment(timestamp), "day")) {
              authorRewardsYesterday += parseFloat(vesting_payout.split(" ")[0]);
            }
          });
          
          let authRewTodTxt = authorRewardsToday.toFixed(3) + " BP";
          $('#authorRewardsToday').val(authRewTodTxt);
          let authRewYesTxt = authorRewardsYesterday.toFixed(3) + " BP";
          $('#authorRewardsYesterday').val(authRewYesTxt);

          if($('#latestAuthorRewards tr').length === 0) {
            var row = $('<tr><td><small>No results...</small></td></tr>');
            authorRewardsTable.append(row);
          }

          let curationRewards = response.slice(0).filter(item => item[1].op[0] === "curation_reward");
          curationRewards.sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
          let curationRewardsTable = $('#latestCurationRewards');
          let curationRewardsToday = 0.0, curationRewardsYesterday = 0.0;
          curationRewards.forEach(item => {
            let { block, op, timestamp } = item[1];
            let { comment_author, reward, comment_permlink } = op[1];
            let timeAgo = moment(timestamp).fromNow();
            let title = `@${comment_author}/${comment_permlink}`;
            var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `${reward.replace("VESTS", "BP")} | <a href="${BLURT_EXPLORER}/${title}" target="_blank">${title}</a>` + '</small></td></tr>');
            curationRewardsTable.append(row);

            if (today.isSame(moment(timestamp), "day")) {
              curationRewardsToday += parseFloat(reward.split(" ")[0]);
            } else if (today.subtract(1, 'days').isSame(moment(timestamp), "day")) {
              curationRewardsYesterday += parseFloat(reward.split(" ")[0]);
            }
          });

          let curRewTodTxt = curationRewardsToday.toFixed(3) + " BP";
          $('#curationRewardsToday').val(curRewTodTxt);
          let curRewYesTxt = curationRewardsYesterday.toFixed(3) + " BP";
          $('#curationRewardsYesterday').val(curRewYesTxt);

          if($('#latestCurationRewards tr').length === 0) {
            var row = $('<tr><td><small>No results...</small></td></tr>');
            curationRewardsTable.append(row);
          }

          let votes = response.slice(0).filter(item => item[1].op[0] === "vote" && item[1].op[1].author === username);
          votes.sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
          let votesTable = $('#latestUpvotes');
          votes.forEach(item => {
            let { block, op, timestamp } = item[1];
            let { author, permlink, voter, weight } = op[1];
            let timeAgo = moment(timestamp).local().fromNow();
            let voteWeight = weight / 100;
            var row = $('<tr><td><small>' + `${timeAgo}` + '</small></td><td><small>' + `<a href="${BLURT_WORLD}/@${voter}" target="_blank">${voter}</a> (${voteWeight}%) upvote <i>${permlink}</i>` + '</small></td></tr>');
            votesTable.append(row);
          });
          if($('#latestUpvotes tr').length === 0) {
            var row = $('<tr><td><small>No results...</small></td></tr>');
            votesTable.append(row);
          }

        });
      }

      let username = "";
      let storedUsername = window.localStorage.getItem("username");
      if (storedUsername) {
        $("#username").val(storedUsername);
        username = storedUsername;
      } else {
        username = $("#username").val();
      }
      $("#usernameDisp").text(username);

      getAccount();
      getPosts();
      getAccountHistory();
      $("#save").on('click', function() {
        $("#latestUpvotes tr").remove();
        $("#latestCurationRewards tr").remove();
        $("#latestAuthorRewards tr").remove();
        $("#latestPosts tr").remove();

        let username = $("#username").val();
        window.localStorage.setItem("username", username);
        $("#usernameDisp").text(username);

        getAccount();
        getPosts();
        getAccountHistory();
      });
      
    </script>
</body>
</head>
</html>